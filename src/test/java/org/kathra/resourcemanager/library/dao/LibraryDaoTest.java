/*
 * Copyright (c) 2020. The Kathra Authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * Contributors:
 *    IRT SystemX (https://www.kathra.org/)
 *
 */

package org.kathra.resourcemanager.library.dao;

import com.arangodb.ArangoCursor;
import com.arangodb.springframework.annotation.Document;
import com.arangodb.springframework.core.ArangoOperations;
import org.kathra.core.model.Library;
import org.kathra.core.model.Resource.StatusEnum;
import org.kathra.core.model.Resource;
import org.kathra.resourcemanager.MappingTestUtils;
import org.kathra.resourcemanager.library.dao.LibraryDao;
import org.kathra.resourcemanager.library.dao.LibraryDb;
import org.kathra.resourcemanager.library.dao.LibraryRepository;
import org.kathra.resourcemanager.resource.dao.ResourceReference;
import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.ArgumentCaptor;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.Mockito;
import org.mockito.junit.jupiter.MockitoExtension;
import org.mockito.junit.jupiter.MockitoSettings;
import org.mockito.quality.Strictness;

import java.util.List;
import java.util.Optional;

import org.kathra.resourcemanager.library.dao.LibraryComponentEdge;
import org.kathra.resourcemanager.library.dao.LibraryComponentEdgeRepository;
import org.kathra.resourcemanager.libraryapiversion.dao.LibraryApiVersionLibraryEdge;
import org.kathra.resourcemanager.libraryapiversion.dao.LibraryApiVersionLibraryEdgeRepository;
import org.kathra.resourcemanager.library.dao.LibraryBinaryRepositoryEdge;
import org.kathra.resourcemanager.library.dao.LibraryBinaryRepositoryEdgeRepository;
import org.kathra.resourcemanager.sourcerepository.dao.SourceRepositoryLibraryEdge;
import org.kathra.resourcemanager.sourcerepository.dao.SourceRepositoryLibraryEdgeRepository;
import org.kathra.resourcemanager.pipeline.dao.PipelineLibraryEdge;
import org.kathra.resourcemanager.pipeline.dao.PipelineLibraryEdgeRepository;


/**
 * Class testing LibrariesDao
 *
 * Auto-generated by resource-db-generator@1.3.0 at 2020-02-06T20:56:19.907Z
 * @author jboubechtoula
 */
@ExtendWith(MockitoExtension.class)
@MockitoSettings(strictness = Strictness.LENIENT)
public class LibraryDaoTest {

    @InjectMocks
    LibraryDao underTest;

	@Mock
	LibraryComponentEdgeRepository libraryComponentEdgeRepository;
	@Mock
	LibraryApiVersionLibraryEdgeRepository libraryApiVersionLibraryEdgeRepository;
	@Mock
	LibraryBinaryRepositoryEdgeRepository libraryBinaryRepositoryEdgeRepository;
	@Mock
	SourceRepositoryLibraryEdgeRepository sourceRepositoryLibraryEdgeRepository;
	@Mock
	PipelineLibraryEdgeRepository pipelineLibraryEdgeRepository;


    @Mock
    LibraryRepository repository;
    @Mock
    ArangoOperations operations;

    private final String CALLER_NAME_MOCKED_SESSION = "stevie wonder ! i'm free !";

    @BeforeEach
    public void beforeEach(){
		underTest.libraryComponentEdgeRepository = libraryComponentEdgeRepository;
		underTest.libraryApiVersionLibraryEdgeRepository = libraryApiVersionLibraryEdgeRepository;
		underTest.libraryBinaryRepositoryEdgeRepository = libraryBinaryRepositoryEdgeRepository;
		underTest.sourceRepositoryLibraryEdgeRepository = sourceRepositoryLibraryEdgeRepository;
		underTest.pipelineLibraryEdgeRepository = pipelineLibraryEdgeRepository;

        Mockito.reset();
        Mockito.when(operations.collection(ResourceReference.class.getAnnotationsByType(Document.class)[0].value())).thenReturn(null);
    }

    @Test
    public void check_convertion_test() throws Exception {
        new MappingTestUtils().testMappingClasses(Library.class, LibraryDb.class, underTest);
    }

    @Test
    public void given_object_when_create_then_work() throws Exception {
        Library object = new Library();

        LibraryDb objectDb = new LibraryDb();
        ArgumentCaptor<?> operationsInsertCapture = ArgumentCaptor.forClass(Object.class);

        ArangoCursor<ResourceReference> noExistingUUID = Mockito.mock(ArangoCursor.class);
        Mockito.when(noExistingUUID.count()).thenReturn((long) 0);
        Mockito.when(operations.query(Mockito.anyString(), Mockito.eq(ResourceReference.class))).thenReturn(noExistingUUID);

        Mockito.when(operations.insert(operationsInsertCapture.capture())).thenReturn(null);

        underTest.create(object, CALLER_NAME_MOCKED_SESSION);

        List<?> valuesCaptured = operationsInsertCapture.getAllValues();
        ResourceReference resourceReferenceCaptured = (ResourceReference) valuesCaptured.get(0);
        LibraryDb objectDbCaptured = (LibraryDb) valuesCaptured.get(1);

        Mockito.verify(operations).query(Mockito.anyString(),  Mockito.eq(ResourceReference.class));
        Mockito.verify(operations).insert(Mockito.any(ResourceReference.class));
        Mockito.verify(operations).insert(Mockito.any(LibraryDb.class));


        Assertions.assertNotNull(resourceReferenceCaptured.uuid);
        Assertions.assertEquals(objectDbCaptured.getId(), resourceReferenceCaptured.uuid);
        Assertions.assertEquals(objectDbCaptured.getStatus(), StatusEnum.PENDING);
        Assertions.assertNotNull(objectDbCaptured.getCreatedAt());
        Assertions.assertEquals(objectDbCaptured.getUpdatedAt(), 0);
        Assertions.assertEquals(objectDbCaptured.getCreatedBy(), CALLER_NAME_MOCKED_SESSION);

        Assertions.assertEquals(object.getId(), resourceReferenceCaptured.uuid);
        Assertions.assertEquals(object.getStatus(), StatusEnum.PENDING);
        Assertions.assertNotNull(object.getCreatedAt());
        Assertions.assertEquals(object.getUpdatedAt(), null);
        Assertions.assertEquals(object.getCreatedBy(), CALLER_NAME_MOCKED_SESSION);
    }

    @Test
    public void given_object_when_update_then_works() throws Exception {

        Library object = new Library();
        object.id("10dc3816-1994-4f81-b8d5-f94dbf29dea5");
        object.setCreatedAt((int) (System.currentTimeMillis()/1000) - 1000);
        object.setUpdatedAt(object.getCreatedAt());

        LibraryDb objectDb = new LibraryDb();
        objectDb.setId("10dc3816-1994-4f81-b8d5-f94dbf29dea5");
        objectDb.setCreatedAt(object.getCreatedAt());
        objectDb.setUpdatedAt(object.getCreatedAt());
        Mockito.when(repository.findById(object.getId())).thenReturn(Optional.of(objectDb));

        ArgumentCaptor<?> saveCapture = ArgumentCaptor.forClass(Object.class);
        Mockito.when(operations.update(Mockito.anyString(), saveCapture.capture())).thenReturn(null);

        underTest.update(object, CALLER_NAME_MOCKED_SESSION);

        ResourceReference resourceReference = (ResourceReference) saveCapture.getValue();

        Mockito.verify(repository).save(objectDb);
        Mockito.verify(operations).update(object.getId(), resourceReference);
        Assertions.assertEquals(object.getUpdatedBy(), CALLER_NAME_MOCKED_SESSION);
    }

    @Test
    public void given_object_when_delete_then_works() throws Exception {

        Library object = new Library();
        object.id("10dc3816-1994-4f81-b8d5-f94dbf29dea5");
        object.setCreatedAt((int) (System.currentTimeMillis()/1000) - 10000);
        object.setUpdatedAt(object.getCreatedAt());

        LibraryDb objectDb = new LibraryDb();
        objectDb.setId("10dc3816-1994-4f81-b8d5-f94dbf29dea5");
        objectDb.setCreatedAt(object.getCreatedAt());
        objectDb.setUpdatedAt(object.getCreatedAt());

        Mockito.when(repository.findById(object.getId())).thenReturn(Optional.of(objectDb));

        ArgumentCaptor<?> saveCapture = ArgumentCaptor.forClass(Object.class);

        Mockito.when(operations.update(Mockito.anyString(), saveCapture.capture())).thenReturn(null);

        underTest.delete(object, CALLER_NAME_MOCKED_SESSION);

        ResourceReference resourceReference = (ResourceReference) saveCapture.getValue();

        Mockito.verify(repository).save(objectDb);
        Mockito.verify(operations).update(object.getId(), resourceReference);

        Assertions.assertEquals(resourceReference.status, StatusEnum.DELETED);
        Assertions.assertEquals(object.getStatus(), StatusEnum.DELETED);
        Assertions.assertEquals(objectDb.getStatus(), StatusEnum.DELETED);
        Assertions.assertEquals(objectDb.getCreatedAt(), object.getCreatedAt().longValue());
        Assertions.assertNotEquals(object.getCreatedAt(), object.getUpdatedAt());
        Assertions.assertEquals(objectDb.getUpdatedAt(), object.getUpdatedAt().longValue());

        Assertions.assertEquals(object.getUpdatedBy(), CALLER_NAME_MOCKED_SESSION);
        Assertions.assertEquals(objectDb.getUpdatedBy(), CALLER_NAME_MOCKED_SESSION);
    }
}
